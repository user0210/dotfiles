#!/bin/sh

## shortest...
#xdotool windowunmap "$WINDOWID"
#$@
#xdotool windowmap "$WINDOWID"


dir=$(pwd)
sess=$(tmux display-message -p '#S')
group=$(tmux display-message -p '#{session_group}')
num=$(tmux ls 2> /dev/null | grep '^sw\-[1-9]' | wc -l)

num=$((num+1))

first_arg=$1
shift
rest_args=$@

tmux rename-session -t $sess sw-$num
tmux set-option destroy-unattached off

if [ 'base' = "$group" ]; then
	tmux detach-client -E "\
		cd $dir && $first_arg $rest_args && \
		tmux attach -t sw-$num \; \
			set-option destroy-unattached \; \
			rename-session -t sw-$num 9"
else
	tmux detach-client -E "\
		cd $dir && $first_arg $rest_args && \
		tmux attach -t sw-$num \; \
			set-option destroy-unattached \; \
			rename-session -t sw-$num $sess"
fi


## with bashisms
#dir=$(pwd)
#sess=$(tmux display-message -p '#S')
#
#all_args=("$@")
#first_arg=$1
#rest_args=("${all_args[@]:1}")
#
#tmux rename-session -t $sess sw-$sess
#tmux set-option destroy-unattached off
#tmux detach-client -E "cd $dir && $first_arg \"${rest_args[@]}\" && tmux attach -t sw-$sess \; set-option destroy-unattached \; rename-session -t sw-$sess $sess"
