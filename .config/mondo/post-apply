#!/bin/bash

# This script is executed AFTER all other applying
# actions and scripts are finished, when mondo is 
# executed with the apply option (-a).

# The intension of this script is to let you adjust
# your environment after applying a new theme.

# For instance one might want to reload certain processes
# like windowmanagers and statusbars. 

# $1 in this script contains the output from
# `pre-apply`. By using eval you can pass multiple
# variables and stuff between the scripts.

# eval "${1}"

select=$(mondo get theme)

##### wallpaper or color-theme
####################################################

if [ 'templer' = "$select" ]; then
	## set alpha
	sed -i "s/^#define transparency.*/#define transparency 0\.85/g" ~/.config/X11/Xresources
else
	## set alpha
	sed -i "s/^#define transparency.*/#define transparency 1\.0/g" ~/.config/X11/Xresources
fi


##### reload terminal
####################################################

  ## source Xresources here not in gnerator for alpha getting loadet
xrdb -merge -I~/.config/X11 ~/.config/X11/Xresources

  ## reaload st-clients
pkill -USR2 "^st$" &

  ## source theme to tmux
tmux source-file -q ~/.config/tmux/tmux.conf


##### set gtk- and icon- theme
####################################################

~/.local/src/materia-gtk/change_color.sh -o Templer <(cat ~/.local/src/materia-gtk/colors) &> /dev/null

  ## copy template-icons and set new color
ICON=$(xrdb -query|awk '/\*color19:/ {print $2}')
ICONBAR=$(xrdb -query|awk '/\*color3:/ {print $2}')

  ## create generic iconset for xmenu and stuff
mkdir ~/.local/share/icons/generic 2> /dev/null
cp -rf ~/.config/X11/xfiles/icons/generic/* ~/.local/share/icons/generic
find ~/.local/share/icons/generic/status/scalable/ -type f -exec sed -i "s/MAINCOLOR/$ICONBAR/g" {} +
find ~/.local/share/icons/generic/ -type f -exec sed -i "s/MAINCOLOR/$ICON/g" {} +

  ## create vimix icon-theme with custom colors
light=$(colort -c $(mondo get base00) && printf 0 || printf 1)
if [ "$light" -eq 0 ]; then
	sed -i "s/^gtk-icon-theme-name=.*/gtk-icon-theme-name=Templer-dark/g" ~/.config/gtk-3.0/settings.ini
	sed -i "s/^gtk-icon-theme-name=.*/gtk-icon-theme-name=\"Templer-dark\"/g" ~/.config/gtk-2.0/gtkrc
else
	sed -i "s/^gtk-icon-theme-name=.*/gtk-icon-theme-name=Templer/g" ~/.config/gtk-3.0/settings.ini
	sed -i "s/^gtk-icon-theme-name=.*/gtk-icon-theme-name=\"Templer\"/g" ~/.config/gtk-2.0/gtkrc
fi
cp -f ~/.config/X11/xfiles/icons/default/* ~/.local/share/icons/Templer/scalable/places
find ~/.local/share/icons/Templer/scalable/places -type f -name "*.svg" -exec sed -i "s/DEFAULT_COLOUR/$(mondo get base0D)/g" {} +

  ## apply gtk-theme on the fly
xsettingsd -c ~/.config/X11/xsettingsd &
pkill -SIGHUP xsettingsd && killall xsettingsd


##### restart/source applications
####################################################

  ## nm-applet
killall nm-applet; nm-applet &

  ## polkit-gtk
killall polkit-gnome-authentication-agent-1; /usr/lib/polkit-gnome/polkit-gnome-authentication-agent-1 &

  ## dwmblocks
killall -9 dwmblocks
make -C ~/.local/src/dwmblocks
dwmblocks &

  ## qutebroser (in some way it depends on gtk2-stuff and so on colors defined above... i dont know why...)
pgrep qutebrowser && qutebrowser :config-source

  ## source dwm...
xsetroot -name "dwm:cmd xrdb"
